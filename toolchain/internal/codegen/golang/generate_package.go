package golang

import (
	"strings"

	"github.com/varavelio/gen"
	"github.com/varavelio/vdl/toolchain/internal/codegen/config"
	"github.com/varavelio/vdl/toolchain/internal/core/ir"
)

var packageHeader = strings.TrimSpace(`
// Code generated by VDL. DO NOT EDIT.
// If you edit this file, it will be overwritten the next time it is generated.
// 
// This file is licensed under the MIT License.
// See https://github.com/varavelio/vdl for more information.
//
// Copyright (c) [Generated by VDL - User retains copyright]
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
// SOFTWARE.

//nolint:all
`)

func generatePackage(_ *ir.Schema, _ *flatSchema, config *config.GoConfig) (string, error) {
	g := gen.New().WithTabs()

	g.Line(packageHeader)
	g.Break()

	g.Linef("// Package %s contains the generated code for the VDL RPC schema", config.Package)
	g.Linef("package %s", config.Package)
	g.Break()

	// Import block - we'll import everything and let goimports clean up unused ones
	// Note: goimports is called at the end of Generate() to handle this
	imports := []string{
		"context",
		"encoding/json",
		"fmt",
		"io",
		"net/http",
		"sync",
		"time",
	}

	if config.GenClient {
		imports = append(imports, "bufio", "bytes", "strings")
	}

	g.Line("import (")
	g.Block(func() {
		for _, imp := range imports {
			g.Linef(`"%s"`, imp)
		}
	})
	g.Line(")")
	g.Break()

	// Add code to prevent errors when not using some imports
	// (goimports will remove these if truly unused)
	g.Line("// No-op to keep the time package when not used")
	g.Line("var _ *time.Time = nil")

	return g.String(), nil
}
